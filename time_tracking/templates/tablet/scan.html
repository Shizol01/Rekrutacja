<!DOCTYPE html>
<html>
<head>
    <title>Skanuj QR</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <h2>Skanuj kod QR</h2>
    <div id="reader" style="width:300px"></div>

    <script>
    const mode = "{{ mode }}";
    const action = "{{ action }}";
    const deviceId = "tablet-01";

    console.log("Tablet scan loaded", mode, action);

    function onScanSuccess(decodedText) {
        console.log("QR scanned:", decodedText);

        html5Qrcode.stop().then(() => {
            if (mode === "register") {
                sendEvent("CHECK_IN", decodedText);
            } else if (mode === "status") {
                location.href = `/api/tablet/status-ui/?qr=${decodedText}`;
            } else if (mode === "action") {
                sendEvent(action, decodedText);
            }
        });
    }

    function sendEvent(eventType, qr) {
        fetch("/api/tablet/events/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                qr: qr,
                event_type: eventType,
                device_id: deviceId
            })
        })
        .then(r => r.json())
        .then(data => {
            console.log("API response:", data);
            location.href = `/api/tablet/message/?message=${encodeURIComponent(data.message)}`;
        });
    }

    const html5Qrcode = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(cameras => {
        if (cameras.length === 0) {
            alert("Brak kamery");
            return;
        }

        html5Qrcode.start(
            cameras[0].id,
            { fps: 10, qrbox: 250 },
            onScanSuccess
        );
    }).catch(err => {
        console.error("Camera error:", err);
        alert("Błąd kamery: " + err);
    });
</script>

</body>
</html>
